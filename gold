#!/usr/bin/env bash 
GOLD=$(cd $( dirname "${BASH_SOURCE[0]}" ) && pwd )
GOLDlib=$HOME/opt/share/awk
GOLDtest=$GOLD/tests
GOLDdoc=$GOLD/docs
AWKPATH="$GOLDlib:./:$AWKPATH"

help() { cat <<EOF
gold: the Gawk object layer

usage: gold [OPTIONS]

OPTIONS:
  -c FILE  transpile FILE (or FILE.gold) to $GOLDlib/FILE.awk 
  -d       write doc for all files in current directory to $GOLDdoc
  -f FILE  run FILE (or FILE.gold) in current directory
  -h       show help
  -l PATH  Set GOLDlib (where the tranpiled code is stored)
  -p FILE  run and profile file (or FILE.gold) in current directory
  -s       list settings
  -t PATH  Set GOLDtest (where the init tests are stored)
  -u       run unit tests from all files in $GOLDtest
  -u FILE  run unit tests from FILE in $GOLDtest
EOF
}
mkdir -p $GOLDlib $GOLDtest $GOLDdoc

gold2awks()  {
  for f in "*.gold"; do
    g=$GOLDlib/${g%.*}.awk
    if [ "$g" -nt "$f" ]; then
      $GOLD/gold.awk --source '{toAwk()}'  $f > $g
    fi
  done
}
gold2docs()  {
  for f in "*.gold"; do
    g=$GOLDdoc/${g%.*}.md
    if [ "$g" -nt "$f" ]; then
      $GOLD/gold.awk --source '{toMd()}'  $f > $g
    fi
  done
}
redgreen() { gawk '
     /^---/ { $0="\033[01;36m"$0"\033[0m" }
     /FAIL/ { bad++; $0="\033[31m"$0"\033[0m" }
     /PASS/ { $0="\033[32m"$0"\033[0m" }
            { print $0                 }
     END    { exit bad!=0 }'
}


while getopts ":f:p:u:c:lhus:d:t:L" options; do   
  case "${options}" in                    # 
    h)                                    # If the option is n,
      help
      ;;
    s)                                    # If the option is t,
      echo "GOLD     = $GOLD"
      echo "GOLDlib  = $GOLDlib"
      echo "GOLDtest = $GOLDtest"
      echo "GOLDdoc  = $GOLDdoc"
      echo "AWKPATH  = $AWKPATH"
      ;;
    d) 
      GOLDdoc=${OPTARG}
      ;;
    t) 
      GOLDtest=${OPTARG}
      ;;
    l) 
      GOLDlib=${OPTARG}
      ;;
    u)                                    # If expected argument omitted:
       cd $GOLDtest
       $GOLD/gold -f ${OPTARG} | redgreen
      ;;
    U) 
      cd $GOLDtest
      for f in *.gold; do $GOLD/gold -t $f; done |  redgreen
      ;;
    p) 
      f=${OPTARG}
      g=$GOLDlib/${f%.*}
      shift $((OPTIND -1))
      COM="gawk -p -f $GOLD/gold.awk -f ${g}.awk"
      if [ -t 0 ]
        then         AWKPATH="$AWKPATH" $COM $@
        else cat - | AWKPATH="$AWKPATH" $COM $@
      fi
      exit
      ;;
    f)
      f=${OPTARG}
      g=$GOLDlib/${f%.*}
      shift $((OPTIND -1))
      COM="gawk -f $GOLDlib/gold.awk -f ${g}.awk"
      if [ -t 0 ]
        then         AWKPATH="$AWKPATH" $COM $@
        else cat - | AWKPATH="$AWKPATH" $COM $@
      fi
      exit
     ;;
    d)
      f=${OPTARG}
      g=$GOLDlib/${f%.*}
      shift
      COM="gawk -f $GOLDlib/gold.awk -f ${g}.awk"
      if [ -t 0 ]
        then         AWKPATH="$AWKPATH" $COM $*
        else cat - | AWKPATH="$AWKPATH" $COM $*
     fi
     ;;
    *)                                    
      help
      ;;
  esac
done
