#!/usr/bin/env ../gold
# vim: filetype=awk nospell ts=2 sw=2 sts=2  et :

@include "lib/gold.awk"
@include "lib/csv.awk"
@include "lib/o.awk"

function DbScan(i) {
  i.clusterColumn=""
  has(i,"clusters")
  has(i,"rows")
  has(i,"poles")
  has(i,"cells")
}
function Row(i,cluster) {
  i.cluster=cluster
  has(i,"pole")
  has(i,"cell")
}
function dbscanMain(f,db) {
  DbScan(db)
  while(csv(a,f)) 
    if (length(db.poles))
      Row1(db,a)
    else
      Row0(db,a) 
   o(db.data)
}
function Row0(db,a,     get,putPole,putCell) {
  for(get in a)
    if (a[get] ~/%poles/)
       db.clusterColumn = get
    else if (a[get] ~ /%pole/)
      db.poles[++putPole] = get 
    else
      db.cells[++putCell] = get
}
function Row1(db,a,  r,cluster,get,put) {
  cluster = a[db.clusterColumn] # which cluster
  r = length(db.rows)+1
  hass(db.rows,r, "Row",cluster)
  db.clusters[cluster][r]
  for(put in db.poles) {
     get = db.poles[put]
     db.rows[r].pole[put] = a[get]
  }
  for(put in db.cells) {
     get = db.cells[put]
     db.rows[r].cell[put] = a[get]
  }
}
